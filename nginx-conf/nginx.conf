# nginx-conf/nginx.conf
#worker_processes 1;

events{
    worker_connections 1024;
}

http {
    # --- 關鍵：定義限流規則 ---
    # $binary_remote_addr：根據客戶端 IP 限制
    # zone=mylimit:10m：分派 10MB 記憶體存取 IP 清單
    # rate=5r/s：每個 IP 每秒只能請求 5 次
    limit_req_zone $binary_remote_addr zone=mylimit:10m rate=5r/s;

    upstream my_backend {
        # 指向電腦 B 的 IP
        server 192.168.0.101:8080;
    }

    server {
        listen 80;

        location / {
            # --- 套用限流規則 ---
            # burst=5：允許短暫的 5 次突發請求
            # nodelay：超過就直接噴 503 錯誤，不排隊
           limit_req zone=mylimit burst=5 nodelay;

            proxy_pass http://my_backend;
        }
    }
}
# events {
#     worker_connections 1024;
# }

# http {
#     # 設置 MIME 類型，確保瀏覽器正確渲染
#     include       mime.types;
#     default_type  application/octet-stream;

#     # 1. 定義 upstream 組
#     # upstream 的名稱是 'backend_servers'
#     upstream backend_servers {
#         # 負載平衡演算法：預設是 Round Robin (輪詢)
#         # 伺服器的名稱對應到 docker-compose.yml 裡 service 的名稱 (app1, app2, app3)
#         # 容器內部通信，端口都是 8080
#         server app1:8080;
#         server app2:8080;
#         server app3:8080;

#         # **測試其他演算法:**
#         # 1. Least Connections (最少連接數):
#         # least_conn; 
        
#         # 2. IP Hash (根據客戶端 IP 分發，實現簡單會話黏性):
#         # ip_hash;
#     }

#     server {
#         listen 80; # Nginx 監聽的端口 (將對外暴露)
#         server_name localhost;

#         location / {
#             # 2. 將所有請求代理到定義的 upstream 組
#             proxy_pass http://backend_servers;

#             # 設置 HTTP Header 以便後端伺服器獲取真實資訊
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         }
#     }
# }